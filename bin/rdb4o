#!/usr/bin/env jruby

if ENV["DEV"]
  require File.dirname(__FILE__) + "/../lib/rdb4o"
else
  require 'rubygems'
  require 'rdb4o'
end

def usage
  puts <<-USAGE
  rdb4o generate [directory]
  rdb4o compile [directory]

  rdb4o generate app/models
USAGE
    exit
end

usage if ARGV.empty?

i ARGV

case ARGV[0]  
when "generate"
  i Dir[ARGV[1] + "/**/*rb"]
  Dir[ARGV[1] + "/**/*rb"].each do |file|
    dir = File.dirname(file)
    package = dir.gsub("/", ".")
    dir += "/java"
    
    require file
    
    until Rdb4o::Model::Generator.classes.empty?
      klazz = Rdb4o::Model::Generator.classes.pop
      i klazz
      Dir.mkdir(dir) unless File.exists?(dir)
      File.open(dir + "/#{klazz}.java", "w") {|f| 
        f.write Rdb4o::Model::Generator.generate!(klazz, package) 
      }
    end
  end
  # Rdb4o::ModelGenerator.generate_all!(ARGV[1])
when "compile"
  # Rdb4o::ModelGenerator.dir = ARGV[1]
  # Rdb4o::ModelGenerator.compile_all!
when "run"
  system "CLASSPATH=#{Rdb4o.jar_classpath}/db4o.jar:#{Rdb4o.jar_classpath}/rdb4o.jar:. jruby #{ARGV[1]}"
else
  usage
end
